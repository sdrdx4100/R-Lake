<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}R-Lake Datalake Platform{% endblock %}</title>
    
    <!-- Basic CSS for fallback styling -->
    <style>
        /* Minimal Bootstrap-like styling */
        .container, .container-fluid { max-width: 1200px; margin: 0 auto; padding: 0 15px; }
        .row { display: flex; flex-wrap: wrap; margin: 0 -15px; }
        .col, .col-md-6, .col-md-8, .col-lg-9, .col-lg-3 { flex: 1; padding: 0 15px; }
        .col-md-6 { flex: 0 0 50%; }
        .col-md-8 { flex: 0 0 66.66%; }
        .col-lg-9 { flex: 0 0 75%; }
        .col-lg-3 { flex: 0 0 25%; }
        .card { border: 1px solid #ddd; border-radius: 0.375rem; margin-bottom: 1rem; }
        .card-header { padding: 0.75rem 1.25rem; background-color: #f8f9fa; border-bottom: 1px solid #ddd; }
        .card-body { padding: 1.25rem; }
        .btn { display: inline-block; padding: 0.375rem 0.75rem; margin-bottom: 0; font-size: 1rem; line-height: 1.5; text-align: center; text-decoration: none; vertical-align: middle; cursor: pointer; border: 1px solid transparent; border-radius: 0.375rem; background-color: #007bff; color: white; }
        .btn:hover { background-color: #0056b3; }
        .btn-outline-primary { background-color: transparent; color: #007bff; border-color: #007bff; }
        .btn-outline-secondary { background-color: transparent; color: #6c757d; border-color: #6c757d; }
        .form-control, .form-select { display: block; width: 100%; padding: 0.375rem 0.75rem; font-size: 1rem; line-height: 1.5; color: #495057; background-color: #fff; border: 1px solid #ced4da; border-radius: 0.375rem; box-sizing: border-box; }
        .form-label { display: inline-block; margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 1rem; }
        .navbar { background-color: #007bff !important; padding: 0.5rem 1rem; }
        .navbar-brand { color: white !important; text-decoration: none; font-weight: bold; }
        .nav-link { color: white !important; text-decoration: none; padding: 0.5rem 1rem; }
        .dropdown-menu { display: none; position: absolute; background-color: white; border: 1px solid #ddd; border-radius: 0.375rem; z-index: 1000; min-width: 160px; }
        .dropdown:hover .dropdown-menu { display: block; }
        .alert { padding: 0.75rem 1.25rem; margin-bottom: 1rem; border: 1px solid transparent; border-radius: 0.375rem; }
        .alert-success { color: #155724; background-color: #d4edda; border-color: #c3e6cb; }
        .alert-danger { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; }
        .table { width: 100%; margin-bottom: 1rem; color: #212529; border-collapse: collapse; }
        .table th, .table td { padding: 0.75rem; vertical-align: top; border-top: 1px solid #dee2e6; }
        .text-center { text-align: center; }
        .text-muted { color: #6c757d; }
        .d-flex { display: flex; }
        .justify-content-between { justify-content: space-between; }
        .align-items-center { align-items: center; }
        .me-2 { margin-right: 0.5rem; }
        .fas::before { content: "📊"; }
        .fa-chart-line::before { content: "📈"; }
        .fa-database::before { content: "🗄️"; }
        .fa-upload::before { content: "⬆️"; }
        .fa-list::before { content: "📋"; }
        .fa-edit::before { content: "✏️"; }
        .fa-download::before { content: "⬇️"; }
        .fa-eye::before { content: "👁️"; }
        .fa-spinner::before { content: "⟳"; }
        .fa-sync::before { content: "🔄"; }
        .fa-expand::before { content: "⛶"; }
        input:required:invalid { border-color: #dc3545; }
    </style>
    
    <!-- Plotly.js fallback -->
    <script>
        // Plotly fallback implementation
        if (typeof Plotly === 'undefined') {
            window.Plotly = {
                newPlot: function(elementId, traces, layout, config) {
                    const element = typeof elementId === 'string' ? document.getElementById(elementId) : elementId;
                    if (element) {
                        element.innerHTML = '<div style="padding: 2rem; text-align: center; border: 2px dashed #ccc; background-color: #f8f9fa;"><h3>グラフプレースホルダー</h3><p>Plotly.jsが利用できません。グラフの代わりにこのプレースホルダーが表示されています。</p><p>データポイント数: ' + (traces && traces.length ? traces.length : 'N/A') + '</p></div>';
                    }
                    return Promise.resolve();
                },
                downloadImage: function() {
                    alert('グラフのダウンロード機能は現在利用できません。');
                },
                offline: {
                    plot: function() {
                        alert('HTMLエクスポート機能は現在利用できません。');
                    }
                }
            };
        }
    </script>
    
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/custom.css' %}">
    
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{% url 'home' %}">
                <i class="fas fa-database me-2"></i>R-Lake
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="dataDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-upload me-1"></i>データ管理
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{% url 'ingest:dataset_list' %}">データセット一覧</a></li>
                            <li><a class="dropdown-item" href="{% url 'ingest:upload_csv' %}">CSV アップロード</a></li>
                        </ul>
                    </li>
                    
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="vizDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-chart-line me-1"></i>可視化
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{% url 'visualization:chart_list' %}">グラフ一覧</a></li>
                            <li><a class="dropdown-item" href="{% url 'visualization:chart_create' %}">グラフ作成</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{% url 'visualization:dashboard_create' %}">ダッシュボード作成</a></li>
                        </ul>
                    </li>
                </ul>
                
                <ul class="navbar-nav">
                    {% if user.is_authenticated %}
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user me-1"></i>{{ user.username }}
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="{% url 'accounts:profile' %}">プロフィール</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <form method="post" action="{% url 'accounts:logout' %}" style="display: inline;">
                                        {% csrf_token %}
                                        <button type="submit" class="dropdown-item" style="border: none; background: none; width: 100%; text-align: left;">
                                            <i class="fas fa-sign-out-alt me-1"></i>ログアウト
                                        </button>
                                    </form>
                                </li>
                            </ul>
                        </li>
                    {% else %}
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'accounts:login' %}">ログイン</a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- Messages -->
    {% if messages %}
        <div class="container mt-3">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Main Content -->
    <main class="container-fluid mt-4">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="bg-light text-center text-muted py-4 mt-5">
        <div class="container">
            <p>&copy; 2025 R-Lake Datalake Platform. 車両データ分析のための包括的なプラットフォーム.</p>
        </div>
    </footer>

    <!-- Vanilla JavaScript replacements for jQuery functionality -->
    <script>
        // Basic utility functions to replace jQuery
        function $(selector) {
            if (typeof selector === 'string') {
                return document.querySelector(selector);
            } else if (typeof selector === 'function') {
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', selector);
                } else {
                    selector();
                }
            }
            return selector;
        }
        
        // Basic AJAX functionality
        function ajax(options) {
            return fetch(options.url, {
                method: options.method || 'GET',
                headers: options.headers || {},
                body: options.data instanceof FormData ? options.data : JSON.stringify(options.data)
            }).then(response => {
                if (options.dataType === 'json') {
                    return response.json();
                }
                return response.text();
            });
        }
        
        // Bootstrap modal replacement
        if (typeof bootstrap === 'undefined') {
            window.bootstrap = {
                Modal: function(element) {
                    return {
                        show: function() { element.style.display = 'block'; },
                        hide: function() { element.style.display = 'none'; },
                        getInstance: function() { return this; }
                    };
                }
            };
        }
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>
