{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}{{ asset.name }} - データアセット詳細{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
    <div>
      <h1 class="mb-1">{{ asset.name }}</h1>
      <div class="text-muted">{{ asset.summary|default:"説明はまだ登録されていません。" }}</div>
    </div>
    <div class="text-end">
      <span class="badge bg-primary me-2">{{ asset.get_asset_type_display }}</span>
      <span class="badge bg-secondary">{{ asset.get_lifecycle_state_display }}</span>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-xl-4">
      <div class="card shadow-sm h-100">
        <div class="card-header">メタデータ</div>
        <div class="card-body">
          <dl class="row mb-0">
            <dt class="col-sm-5">ドメイン</dt>
            <dd class="col-sm-7">{% if asset.domain %}<a href="{% url 'catalog:domain_detail' asset.domain.slug %}">{{ asset.domain.name }}</a>{% else %}<span class="text-muted">未設定</span>{% endif %}</dd>
            <dt class="col-sm-5">ソース</dt>
            <dd class="col-sm-7">{% if asset.source %}<a href="{% url 'catalog:source_detail' asset.source.slug %}">{{ asset.source.name }}</a>{% else %}<span class="text-muted">未設定</span>{% endif %}</dd>
            <dt class="col-sm-5">オーナー</dt>
            <dd class="col-sm-7">{{ asset.owner|default:"未登録" }}</dd>
            <dt class="col-sm-5">ステュワード</dt>
            <dd class="col-sm-7">{{ asset.steward|default:"未登録" }}</dd>
            <dt class="col-sm-5">リフレッシュ頻度</dt>
            <dd class="col-sm-7">{{ asset.refresh_cadence|default:"未設定" }}</dd>
            <dt class="col-sm-5">保持ポリシー</dt>
            <dd class="col-sm-7">{% if asset.retention_days %}{{ asset.retention_days }} 日{% else %}<span class="text-muted">未設定</span>{% endif %}</dd>
            <dt class="col-sm-5">分類</dt>
            <dd class="col-sm-7">{{ asset.get_data_classification_display }}</dd>
            <dt class="col-sm-5">タグ</dt>
            <dd class="col-sm-7">{{ asset.tags|default:"-" }}</dd>
          </dl>
        </div>
      </div>
    </div>
    <div class="col-xl-8">
      <div class="card shadow-sm h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div>品質サマリー</div>
          {% if asset.dataset %}<a href="{% url 'ingest:dataset_detail' asset.dataset.pk %}" class="btn btn-sm btn-outline-primary">データセットへ</a>{% endif %}
        </div>
        <div class="card-body">
          {% if latest_metric %}
          <div class="row g-3">
            <div class="col-md-4">
              <div class="border rounded p-3 h-100">
                <div class="text-muted">品質スコア</div>
                <div class="display-6 fw-bold">{% if latest_metric.quality_score is not None %}{{ latest_metric.quality_score|floatformat:1 }}{% else %}-{% endif %}</div>
                <div class="text-muted small">測定日時: {{ latest_metric.metric_date|date:"Y/m/d H:i" }}</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="border rounded p-3 h-100">
                <div class="text-muted">完全性</div>
                <div class="display-6 fw-bold">{% if latest_metric.completeness_percent is not None %}{{ latest_metric.completeness_percent|floatformat:1 }}{% else %}-{% endif %}<span class="fs-5">%</span></div>
                <div class="progress mt-2" style="height: 6px;">
                  <div class="progress-bar bg-success" style="width: {{ latest_metric.completeness_percent|default_if_none:0 }}%"></div>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="border rounded p-3 h-100">
                <div class="text-muted">ユニーク率</div>
                <div class="display-6 fw-bold">{% if latest_metric.uniqueness_percent is not None %}{{ latest_metric.uniqueness_percent|floatformat:1 }}{% else %}-{% endif %}<span class="fs-5">%</span></div>
                <div class="progress mt-2" style="height: 6px;">
                  <div class="progress-bar bg-info" style="width: {{ latest_metric.uniqueness_percent|default_if_none:0 }}%"></div>
                </div>
              </div>
            </div>
          </div>
          <hr>
          <div class="row text-center">
            <div class="col-md-4">
              <div class="text-muted">総レコード</div>
              <div class="fs-4 fw-semibold">{{ latest_metric.total_records|intcomma }}</div>
            </div>
            <div class="col-md-4">
              <div class="text-muted">有効レコード</div>
              <div class="fs-4 fw-semibold text-success">{{ latest_metric.valid_records|intcomma }}</div>
            </div>
            <div class="col-md-4">
              <div class="text-muted">エラー / 重複</div>
              <div class="fs-5 fw-semibold text-danger">{{ latest_metric.invalid_records|intcomma }} / {{ latest_metric.duplicate_records|intcomma }}</div>
            </div>
          </div>
          {% else %}
          <p class="text-muted mb-0">まだ品質レポートが生成されていません。取り込み後に <strong>データ品質レポート</strong> を作成するとメトリクスが表示されます。</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 mt-1">
    <div class="col-xl-8">
      <div class="card shadow-sm">
        <div class="card-header">データカラム</div>
        <div class="table-responsive">
          <table class="table table-striped table-hover mb-0 align-middle">
            <thead class="table-light">
              <tr>
                <th>カラム名</th>
                <th>型</th>
                <th>NULL</th>
                <th>分類</th>
                <th>統計情報</th>
              </tr>
            </thead>
            <tbody>
              {% for column in columns %}
              <tr>
                <td>{{ column.name }}</td>
                <td>{{ column.data_type }}</td>
                <td>{% if column.is_nullable %}<span class="badge bg-secondary">許可</span>{% else %}<span class="badge bg-danger">禁止</span>{% endif %}</td>
                <td>{{ column.get_classification_display }}</td>
                <td class="small text-muted">
                  {% if column.stat_min is not None %}min {{ column.stat_min|floatformat:2 }}, {% endif %}
                  {% if column.stat_max is not None %}max {{ column.stat_max|floatformat:2 }}, {% endif %}
                  {% if column.stat_mean is not None %}mean {{ column.stat_mean|floatformat:2 }}, {% endif %}
                  {% if column.stat_distinct is not None %}distinct {{ column.stat_distinct|intcomma }}{% endif %}
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="5" class="text-center text-muted py-4">まだカラム情報が登録されていません。</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="col-xl-4">
      <div class="card shadow-sm mb-3">
        <div class="card-header">データ契約</div>
        <div class="card-body">
          {% if contracts %}
          <ul class="list-group list-group-flush">
            {% for contract in contracts %}
            <li class="list-group-item">
              <div class="fw-semibold">{{ contract.consumer_team }}</div>
              <div class="text-muted small">{{ contract.refresh_schedule|default:"スケジュール未設定" }}</div>
              <div class="small mt-1">{{ contract.contract_summary|default:"詳細は登録されていません。" }}</div>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <p class="text-muted mb-0">このアセットにはまだデータ契約が紐づいていません。</p>
          {% endif %}
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-header">最近のスナップショット</div>
        <ul class="list-group list-group-flush">
          {% for snapshot in recent_snapshots %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <div class="fw-semibold">{{ snapshot.metric_date|date:"Y/m/d H:i" }}</div>
              <div class="text-muted small">{% if snapshot.quality_score is not None %}{{ snapshot.quality_score|floatformat:1 }}{% else %}-{% endif %} 点</div>
            </div>
            <span class="badge bg-light text-dark">{{ snapshot.total_records|intcomma }} 件</span>
          </li>
          {% empty %}
          <li class="list-group-item text-muted">履歴はまだありません。</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>

  <div class="row g-3 mt-1">
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header">上流リネージ</div>
        <ul class="list-group list-group-flush">
          {% for link in upstream %}
          <li class="list-group-item">
            <div class="fw-semibold"><a href="{% url 'catalog:asset_detail' link.upstream_asset.slug %}">{{ link.upstream_asset.name }}</a></div>
            <div class="text-muted small">{{ link.get_transformation_type_display }} / {{ link.transformation_description|default:"説明なし" }}</div>
          </li>
          {% empty %}
          <li class="list-group-item text-muted">上流に紐づくアセットはありません。</li>
          {% endfor %}
        </ul>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header">下流リネージ</div>
        <ul class="list-group list-group-flush">
          {% for link in downstream %}
          <li class="list-group-item">
            <div class="fw-semibold"><a href="{% url 'catalog:asset_detail' link.downstream_asset.slug %}">{{ link.downstream_asset.name }}</a></div>
            <div class="text-muted small">{{ link.get_transformation_type_display }} / {{ link.transformation_description|default:"説明なし" }}</div>
          </li>
          {% empty %}
          <li class="list-group-item text-muted">下流に紐づくアセットはありません。</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>
{% endblock %}
